<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="css/style.css">
        <title>Alarm Clock</title>
    </head>
    <body>
        <section class="clTelaPrincipal" id="idTelaPrincipal">

            <header class="clCabecalhoPrincipal">
                <div class="clPrevisaoDoTempo">
                    <output class="clTemperaturaMinima" id="tempMin"></output>
                    <output class="clTemperaturaMáxima" id="tempMax"></output>
                    <output class="clTemperaturaAtual" id="tempNow"></output>
                </div>
                <div class="clImagemPrevisaoDoTempo">
                    
                </div>
            </header>

            <main class="clInfoPrincipal">
                <div class="clInformacoes">
                    
                    <output class="clHoraCerta" id="horaCerta"></output>
                
                    <output class="clDataCerta" id="hoje"></output>
                
                    <output class="clMensagem" id="msn"></output>
                
                    <output class="clDescricaoEvento" id="description">It´s time for lunch with the new customers</output>
                
                    <button type="button" name="nmBtnAlarme" id="idBtnAlarme" class="clBotaoAlarme" value="Set Alarm"><img src="assets/icons/time_icon.png" alt="Imagem relógio"> <p>Set Alarm</p></button>
                
                </div>
            </main>

            <footer class="clRodapePrincipal">
                <a href="#idTelaConfiguração" class="clIconeConfiguracao"><img id="idIconeConfiguracao" alt="home" src="./assets/icons/configuration_settings_icon3.png"></a>
            </footer>
        </section>

        <section class="clTelaConfiguração" id="idTelaConfiguração">
            
            <header class="clCabecalhoConfiguracao">
                <h1>Config</h1>
            </header>
            
            <main class="clInfoConfiguracao">
                <form class="clFormularioConfiguracao">
                    <div class="clLabelFormato">
                        <label for="formatoHora">Time Format</label>
                    </div>
                    <div class="clFormato">
                        <input type="radio" id="idFormato12" name="formatoHora" value="12" checked>
                        <label for="idFormato12" class="formatoHora">12</label>
                        <input type="radio" id="idFormato24" name="formatoHora" value="24">
                        <label for="idFormato24" class="formatoHora">24</label>
                    </div>
                    <div class="clLabelTemperatura">
                        <label for="escalaTemp">Temperature</label>
                    </div>
                    <div class="clTemperatura">
                        <input type="radio" id="idCelsius" name="escalaTemp" value="C" checked>
                        <label for="idCelsius" class="escalaTemp">°C</label>
                        <input type="radio" id="idFahrenheit" name="escalaTemp" value="F">
                        <label for="idFahrenheit" class="escalaTemp">°F</label>
                        <input type="radio" id="idKelvin" name="escalaTemp" value="K">
                        <label for="idKelvin" class="escalaTemp">°K</label>
                    </div>
                    <div class="clCidade">
                        <input type="text" id="idCidade" name="cidade" placeholder="City">
                    </div>
                    <div class="clGenero">
                        <input type="radio" id="idMr" name="sexo" value="Mr" checked>
                        <label for="idMr">Mr.</label>
                        <input type="radio" id="idMrs" name="sexo" value="Mrs">
                        <label for="idMrs" class="sexo">Mrs.</label>
                    </div>
                    <div class="clNome">
                        <input type="text" id="idNome" name="nome" placeholder="Name">
                    </div>
                    <div class="clBotaoSalvarConfiguracao">
                        <button type="button" id="idBtnSalvar" value="Save">Save</button>
                    </div>
                    <br><br>

                    <output id="idMessageSettings"></output>
                </form>
            </main>

            <footer class="clRodapeConfiguracao">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundConfiguracao">
                <img  src="./assets/icons/34262_config_configuration_engine_options_preferences_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>
            
        </section>

        <section class="clTelaAlarme" id="idTelaAlarme">

            <header class="clCabecalhoAlarme">
                <h1>Alarm</h1>
                <a href="#idTelaNovoAlarme">new alarm</a>
            </header>
            
            <main class="clInfoAlarme">
                
            </main>
            
            <footer class="clRodapeAlarme">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundRelogio">
                <img  src="./assets/icons/time_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>

        </section>

        <section class="clTelaNovoAlarme" id="idTelaNovoAlarme">

            <header class="clCabecalhoNovoAlarme">
                <h1>New Alarm</h1>
            </header>

            <main class="clInfoNovoAlarme">

                <div class="clTime">
                    <label class="clLabelTempo" for="idHora" >Time</label>
                    <input class="clHora" type="text" id="idHora" placeholder="10:30">

                    <div class="clPeriodoAm">
                        <input type="radio" id="idAm" name="nmPeriodo" value="AM" checked>
                        <label for="idAm">am</label>
                    </div>
                    <div class="clPeriodoPm">
                        <input type="radio" id="idPm" name="nmPeriodo" value="PM">
                        <label for="idPm">pm</label>
                    </div>  

                    <input class="clDescricao" type="text" id="idDescrição" maxlength="50" placeholder="Description">  
                </div>
                
                <button type="button" id="idBtnSaveNewAlarm" class="clBotaoSalvarAlarme">Save</button>
                <br><br>

                <output id="idMessageNewAlarm"></output>

            </main>

            <footer class="clRodapeNovoAlarme">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundCalendario">
                <img  src="./assets/icons/34257_calendar_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>
            
        </section>

        <script>

            /* Script tela Principal*/

            var fieldTempMin = document.getElementById("tempMin");
            var fieldTempMax = document.getElementById("tempMax");
            var fieldTempNow = document.getElementById("tempNow");
            var divWeatherImage = document.querySelector("div[class='clImagemPrevisaoDoTempo']");

            var fieldTime = document.getElementById("horaCerta");
            var fieldDate = document.getElementById("hoje");
            var fieldMessage = document.getElementById("msn");
            var btnAlarm = document.getElementById("idBtnAlarme");

            var config = {}; 
            var city = "";
            var weatherForecast = {};

            var time = "";
            var timeList = [];
            var alarms = {};

            document.addEventListener("DOMContentLoaded", async function() {

                setInitialInfo();
            });

            async function setInitialInfo() {

                config = await getConfig();
                
                if (config.value) {
                    config = config.value;
                } 
        
                if (config.cidade) {
                    city = config.cidade;
                }

                weatherForecast = await getClima(city);
                setInfoWeather(weatherForecast);

                time = "";
                setClock();

                var today = await getHoje();
                fieldDate.value = today.hoje;

                var message = await getMessage();
                fieldMessage.value = message.mensagem;

                alarms = await getAlarm();
                if (alarms.status == 0) {
                    createAlarms(alarms.alarms);
                }
            
            }

             async function getClima(city) {

                const response = await fetch(`http://localhost:3001/clima?cidade=${city}`);
                const data = await response.json();
                
                return data;
            }

            setInterval(() => {
                updateWeather();
            }, (1000 * 60 * 15));
            
            async function updateWeather() {
                
                var weatherForecastNow = await getClima(city);

                const keys = Object.keys(weatherForecastNow);

                keys.forEach(key => {

                    if (weatherForecastNow[key] != weatherForecast[key]) {
                        weatherForecast = weatherForecastNow;
                        setInfoWeather(weatherForecast);
                    }

                });
            }

            function setInfoWeather(weather) {

                fieldTempMin.value = "Min: " + weather.tempMin + " °C";
                fieldTempMax.value = "Max: " + weather.tempMax + " °C";
                fieldTempNow.value = "Now: " + weather.tempNow + " °C";

                var weatherImage = document.createElement('img');
                weatherImage.className = "clIconeTempo";

                switch (weather.condition_slug) {
                    case "storm":
                        weatherImage.src = "./assets/icons/storm_icon.png";
                        weatherImage.alt = "Imagem de nuvem com raios indicando tempestade";
                        break;
                    case "snow":
                        weatherImage.src = "./assets/icons/snow_icon.png";
                        weatherImage.alt = "Imagem de nuvem com neve";
                        break;
                    case "cloud":
                    case "fog":
                        weatherImage.src = "./assets/icons/overcast_icon.png";
                        weatherImage.alt = "Imegm de nuvem indicando tempo nublado ou com neblina";
                        break;
                    case "hail":
                        weatherImage.src = "./assets/icons/scattered_showers_icon.png";
                        weatherImage.alt = "Imagem de nuvem com granizo";
                        break;
                    case "clear_day":
                    case "none_day":
                        weatherImage.src = "./assets/icons/clear_weather_icon.png";
                        weatherImage.alt = "Imagem do sol indicando dia ensolarado";
                        break;
                    case "clear_night":
                    case "none_night":
                        weatherImage.src = "./assets/icons/night_icon.png";
                        weatherImage.alt = "Imagem da lua indicando noite com céu limpo";
                        break;
                    case "rain":
                        weatherImage.src = "./assets/icons/showers_icon.png";
                        weatherImage.alt = "Imagem de nuvem com chuva indicando dia chuvoso";
                        break;
                    case "cloudly_day":
                        weatherImage.src = "./assets/icons/clouds_icon.png";
                        weatherImage.alt = "Imagem do sol com nuvens indicando dia nublado";
                        break;
                    case "cloudly_night":
                        weatherImage.src = "./assets/icons/clouds_night_icon.png";
                        weatherImage.alt = "Imagem da lua com nuvens indicando noite com céu nublado";
                        break;
                    default:
                        break;
                }

                if (divWeatherImage.hasChildNodes()) {
                    divWeatherImage.removeChild(divWeatherImage.firstChild);
                }

                divWeatherImage.appendChild(weatherImage);
            }

            async function getHoraCerta() {

                const response = await fetch(`http://localhost:3001/horaCerta`);
                const data = await response.json();

                return data;
            }

            setInterval(() => {
                setClock();
            }, 1000);

            async function setClock() {

                if (time == "") {

                    time =  await getHoraCerta();
                    timeList = time.horaCerta.split(":");

                } else if ((timeList[1] == 0) && (timeList[2] == 0)) {

                    time = await getHoraCerta();
                    timeList = time.horaCerta.split(":");
                    
                    if ((timeList[0] == "00") && (timeList[1] == "00") && (timeList[2] == "00")) {
                        var today = await getHoje();
                        fieldDate.value = today.hoje;
                    }

                    var message = await getMessage();
                    fieldMessage.value = message.mensagem;

                }

                if (config.formatoHora == "12") {

                    if(Number(timeList[0]) > 12) {
                        timeList[0] = Number(timeList[0]) - 12;
                    }
                }

                if (timeList[2] < 60) {
                    timeList[2] = Number(timeList[2]) + 1;

                    if(timeList[2] == 60) {
                        timeList[2] = 0;
                        timeList[1] = Number(timeList[1]) + 1;

                        if(timeList[1] == 60) {
                            timeList[1] = 0;
                            timeList[0] = Number(timeList[0]) + 1;
                        }
                    }
                }

                if ((timeList[0] < 10) && (String(timeList[0]).length == 1)) {
                    timeList[0] = "0" + timeList[0];
                }

                if ((timeList[1] < 10) && (String(timeList[1]).length == 1)) {
                    timeList[1] = "0" + timeList[1];
                }
        
                if ((timeList[2] < 10) && (String(timeList[2]).length == 1)) {
                    timeList[2] = "0" + timeList[2];
                }

                var hour = timeList[0] + ":" + timeList[1] + ":" + timeList[2];
                
                fieldTime.value = hour;
            }
            
            async function getHoje() {

                const response = await fetch(`http://localhost:3001/hoje`);
                const data = await response.json();
                
                return data;
            }
            
            async function getMessage() {

                const response = await fetch(`http://localhost:3001/message`);
                const data = await response.json();
                
                return data;

            }

            document.body.addEventListener("click", async function(event) {

                var element = event.target;

                if (element.id == "idIconeConfiguracao") {
                    const data = await getConfig();
                    setInfoConfig(data);
                }

            })

            /* Script tela Config */

            var radioButtonFormat = document.querySelectorAll("input[name='formatoHora']");
            var radioButtonTemperatureScale = document.querySelectorAll("input[name='escalaTemp']");
            var radioButtonGender = document.querySelectorAll("input[name='sexo']");
            var fieldCity = document.getElementById("idCidade");
            var fieldName = document.getElementById("idNome");
            var buttonSaveSettings = document.getElementById("idBtnSalvar");
            var fieldMessageSettings = document.getElementById("idMessageSettings");

            buttonSaveSettings.addEventListener("click", postConfig);

            async function getConfig() {

                const response = await fetch(`http://localhost:3001/config`);
                const data = await response.json();
                
                return data;
            }

            function setInfoConfig(info) {

                radioButtonFormat.forEach(element => {
                    
                    if (element.value == info.value.formatoHora) {
                        element.checked = true;
                    }
                });

                radioButtonTemperatureScale.forEach(element => {

                    if (element.value == info.value.escalaTemperatura) {
                        element.checked = true;
                    }
                });

                fieldCity.value = info.value.cidade;

                radioButtonGender.forEach(element => {
                    
                    if (element.value == info.value.genero) {
                        element.checked = true;
                    }
                });

                fieldName.value = info.value.nome;

            }

            async function postConfig() {

                var informations = await getInfoConfig();
                
                const settings = {  method: 'POST',
                                    headers: {
                                                Accept: 'application/json',
                                                'Content-Type': 'application/json',
                                            }
                                };

                const response = await fetch(`http://localhost:3001/config${informations}`, settings);
                const data = await response.json();

                if (data.mensagem != undefined) {
                    fieldMessageSettings.value = data.mensagem;
                } else {
                    fieldMessageSettings.value = "Informações gravadas com sucesso!";
                }

                setTimeout(() => {
                    fieldMessageSettings.value = "";
                }, 5000);
                
            }

            async function getInfoConfig() {
                
                var hourFormat;
                var temperatureScale;
                var city; 
                var gender;
                var name;

                radioButtonFormat.forEach(element => {
                    
                    if (element.checked == true) {
                        hourFormat = element.value;
                    }
                });

                radioButtonTemperatureScale.forEach(element => {

                    if (element.checked == true) {
                        temperatureScale = element.value;
                    }
                });

                city = fieldCity.value;

                radioButtonGender.forEach(element => {
                    
                    if (element.checked == true) {
                        gender = element.value;
                    }

                });

                name = fieldName.value;

                var informations = `?formatoHora=${hourFormat}&escalaTemperatura=${temperatureScale}&cidade=${city}&genero=${gender}&nome=${name}`;

                return informations;
            }

            /* Script tela Alarm */

            document.body.addEventListener("change", function(event) {

                var counter = 0;
                var element = event.target;

                if (element.className == "clAlarm") {
                   
                    alarms.alarms.forEach(alarm => {
            
                        counter++;

                        if (element.id == ("idAlarm" + counter)) {
                            if (alarm.isAtivo == true) {
                                alarm.isAtivo = false;
                            } else {
                                alarm.isAtivo = true;
                            }
                        }

                        console.log(alarm);
                    });

                    
                }
            });

            function createAlarms(alarmsList) {

                var counter = 0;
                var infoAlarm = document.getElementsByClassName("clInfoAlarme");

                while(infoAlarm[0].hasChildNodes()) {
                    infoAlarm[0].removeChild(infoAlarm[0].firstChild);
                }
                
                alarmsList.forEach(element => {

                    counter++;

                    var alarmDiv = document.createElement('div');
                    alarmDiv.className = "clAlarme";

                    var alarmCheckbox = document.createElement('input');
                    alarmCheckbox.type = "checkbox";
                    alarmCheckbox.id= "idAlarm" + counter;
                    alarmCheckbox.name = "nmAlarm" + counter;
                    alarmCheckbox.className = "clAlarm";

                    if (element.isAtivo == true) {
                        alarmCheckbox.checked = true;
                    } else {
                        alarmCheckbox.checked = false;
                    }

                    var alarmLabel = document.createElement('label');
                    alarmLabel.htmlFor = "idAlarm" + counter;

                    if (element.isAm == true) {
                        alarmLabel.innerText = element.hora + "am";
                    } else {
                        alarmLabel.innerText = element.hora + "pm";
                    }

                    var alarmText = document.createElement('p');
                    alarmText.innerText = element.descricao;

                    alarmDiv.appendChild(alarmCheckbox);
                    alarmDiv.appendChild(alarmLabel);
                    alarmDiv.appendChild(alarmText);
                    infoAlarm[0].appendChild(alarmDiv);
                     
                });

            }

            /* Script tela New Alarm */

            var periodSelected = true;
            
            var fieldHour = document.getElementById("idHora");
            var fieldDescription = document.getElementById("idDescrição");
            var btnSaveNewAlarm = document.getElementById("idBtnSaveNewAlarm");
            var fieldMessageNewAlarm = document.getElementById("idMessageNewAlarm");
            
            btnSaveNewAlarm.addEventListener("click", saveAlarm);

            async function saveAlarm() {
                
                var hour = consistHour();
                var description = fieldDescription.value;

                if (hour != false) {

                    var alarmInfo = `?isAtivo=${true}&hora=${hour}&isAm=${periodSelected}&descricao=${description}`;
                    var response = await postAlarm(alarmInfo);
                    
                    if (response.status != 0) {

                        fieldMessageNewAlarm.value = response.mensagem;

                        setTimeout(() => {
                            fieldMessageNewAlarm.value = "";
                            fieldHour.value = "";
                            fieldDescription.value = "";
                            var fieldPeriod = document.getElementById("idAm");
                            fieldPeriod.checked = true;
                            periodSelected = true;
                        }, 5000);

                    } else {

                        alarms = getAlarm();
                        createAlarms(alarms.alarms);
                    }

                } else {
                    fieldMessageNewAlarm.value = "Por favor informe uma hora no intervalo de 00:00 às 11:59";

                    setTimeout(() => {
                        fieldMessageNewAlarm.value = "";
                    }, 5000);
                } 
            }

            async function getAlarm() {

                const response = await fetch(`http://localhost:3001/alarms`);
                const data = await response.json();

                return data;
            }

            async function postAlarm(alarmInfo) {

                const settings = {  method: 'POST',
                                    headers: {
                                                Accept: 'application/json',
                                                'Content-Type': 'application/json',
                                            }
                                };

                const response = await fetch(`http://localhost:3001/alarms${alarmInfo}`, settings);
                const data = await response.json();

                return data;
            }

            function consistHour() {

                var hour = String(fieldHour.value);
                var timeList = hour.split(":");

                for (let index = 0; index < timeList.length; index++) {
                    
                    if (index == 0) {
                        if ((timeList[index] == undefined) || (timeList[index] == "") || (timeList[index] > 11)) {

                            return false;
                        } else if ((timeList[index].length == 1) && (timeList[index] < 10)) {

                            timeList[index] = "0" + timeList[index];
                        }
                    }

                    if (index == 1) {
                        if (timeList[index] > 59) {

                            return false;
                        } else if ((timeList[index].length == 1) && (timeList[index] < 10)) {

                            timeList[index] = "0" + timeList[index];
                        } else if (timeList[index] == "")  {

                            timeList[index] = "00";
                        }           
                    } 
                    
                }           

                if ((timeList[1] == undefined)) {
                    timeList[1] = "00";
                }

                for (let index = 0; index < timeList.length; index++) {
                    
                    if (index == 0) {
                        
                        if ((periodSelected == false) && (timeList[index] == "00")) {
                            timeList[index] = "12";
                        }

                        hour = timeList[index];
                    } else {
                        hour += ":" + timeList[index];
                    }
                }

                return hour;
            }

            fieldHour.addEventListener("keydown", function(event){

                var key = event.key;
                var condition = (((key >= 0) && (key <= 9)) || (key == "Backspace"));

                if (key == "Tab") {
                    fieldDescription.focus();
                }

                if (condition == false) {

                    event.preventDefault();

                } else if (key != "Backspace"){

                    var hour = String(fieldHour.value);

                    if (hour.length <= 4) {

                        while (hour.indexOf(":") > 0) {
                            hour = hour.replace(":","");
                        }

                        fieldHour.value = hour.replace(/.{2}/g, '$&:');     
                    } else {
                        event.preventDefault();
                    } 
                }

            });

            document.body.addEventListener("change", function(event) {

                var element = event.target;

                if ((element.id == "idAm") || (element.id == "idPm")) {

                    var period = document.querySelector('input[name="nmPeriodo"]:checked').value;

                    if (period == "AM") {
                        periodSelected = true;
                    } else {
                        periodSelected = false;
                    }
                }
            });


        </script>

    </body>
</html>