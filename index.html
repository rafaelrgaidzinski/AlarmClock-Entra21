<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="css/style.css">
        <title>Alarm Clock</title>
    </head>
    <body>
        <section class="clTelaPrincipal" id="idTelaPrincipal">

            <header class="clCabecalhoPrincipal">
                <div class="clPrevisaoDoTempo">
                    <output class="clTemperaturaMinima" id="tempMin">Min: 10ºC</output>
                    <output class="clTemperaturaMáxima" id="tempMax">Max: 25ºC</output>
                    <output class="clTemperaturaAtual" id="tempNow">Now: 15ºC</output>
                </div>
                <div class="clImagemPrevisaoDoTempo">
                    <img class="clIconeTempo" src="./assets/icons/clear_weather_icon.png" alt="Clear Weather Icon">
                    <img class="clIconeTempo" src="./assets/icons/clouds_icon.png" alt="Clouds Icon" hidden>
                    <img class="clIconeTempo" src="./assets/icons/clouds_night_icon.png" alt="Clouds Night Icon" hidden>
                    <img class="clIconeTempo" src="./assets/icons/night_icon.png" alt="Night Icon" hidden>
                    <img class="clIconeTempo" src="./assets/icons/showers_icon.png" alt="Showers Icon" hidden>
                    <img class="clIconeTempo" src="./assets/icons/snow_icon.png" alt="Snow Icon" hidden>
                    <img class="clIconeTempo" src="./assets/icons/storm_icon.png" alt="Storm Icon" hidden>
                </div>
            </header>

            <main class="clInfoPrincipal">
                <div class="clInformacoes">
                    
                    <output class="clHoraCerta" id="horaCerta">12:30:56</output>
                
                    <output class="clDataCerta" id="hoje">Fri Jun 17th, 2022</output>
                
                    <output class="clMensagem" id="msn">Good Afternoon Mr. Hendrik, its 12:30 pm</output>
                
                    <output class="clDescricaoEvento" id="description">It´s time for lunch with the new customers</output>
                
                    <button type="button" name="nmBtnAlarme" id="idBtnAlarme" class="clBotaoAlarme" value="Set Alarm"><img src="assets/icons/time_icon.png" alt="Imagem relógio"> <p>Turn Alarm Off</p></button>
                
                </div>
            </main>

            <footer class="clRodapePrincipal">
                <a href="#idTelaConfiguração" class="clIconeConfiguracao"><img id="idIconeConfiguracao" alt="home" src="./assets/icons/configuration_settings_icon3.png"></a>
            </footer>
        </section>

        <section class="clTelaConfiguração" id="idTelaConfiguração">
            
            <header class="clCabecalhoConfiguracao">
                <h1>Config</h1>
            </header>
            
            <main class="clInfoConfiguracao">
                <form class="clFormularioConfiguracao">
                    <div class="clLabelFormato">
                        <label for="formatoHora">Time Format</label>
                    </div>
                    <div class="clFormato">
                        <input type="radio" id="idFormato12" name="formatoHora" value="12" checked>
                        <label for="idFormato12" class="formatoHora">12</label>
                        <input type="radio" id="idFormato24" name="formatoHora" value="24">
                        <label for="idFormato24" class="formatoHora">24</label>
                    </div>
                    <div class="clLabelTemperatura">
                        <label for="escalaTemp">Temperature</label>
                    </div>
                    <div class="clTemperatura">
                        <input type="radio" id="idCelsius" name="escalaTemp" value="C" checked>
                        <label for="idCelsius" class="escalaTemp">°C</label>
                        <input type="radio" id="idFahrenheit" name="escalaTemp" value="F">
                        <label for="idFahrenheit" class="escalaTemp">°F</label>
                        <input type="radio" id="idKelvin" name="escalaTemp" value="K">
                        <label for="idKelvin" class="escalaTemp">°K</label>
                    </div>
                    <div class="clCidade">
                        <input type="text" id="idCidade" name="cidade" placeholder="City">
                    </div>
                    <div class="clGenero">
                        <input type="radio" id="idMr" name="sexo" value="Mr" checked>
                        <label for="idMr">Mr.</label>
                        <input type="radio" id="idMrs" name="sexo" value="Mrs">
                        <label for="idMrs" class="sexo">Mrs.</label>
                    </div>
                    <div class="clNome">
                        <input type="text" id="idNome" name="nome" placeholder="Name">
                    </div>
                    <div class="clBotaoSalvarConfiguracao">
                        <button type="button" id="idBtnSalvar" value="Save">Save</button>
                    </div>
                    <br><br>

                    <output id="idMessageSettings"></output>
                </form>
            </main>

            <footer class="clRodapeConfiguracao">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundConfiguracao">
                <img  src="./assets/icons/34262_config_configuration_engine_options_preferences_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>
            
        </section>

        <section class="clTelaAlarme" id="idTelaAlarme">

            <header class="clCabecalhoAlarme">
                <h1>Alarm</h1>
                <a href="#idTelaNovoAlarme">new alarm</a>
            </header>
            
            <main class="clInfoAlarme">
                
            </main>
            
            <footer class="clRodapeAlarme">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundRelogio">
                <img  src="./assets/icons/time_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>

        </section>

        <section class="clTelaNovoAlarme" id="idTelaNovoAlarme">

            <header class="clCabecalhoNovoAlarme">
                <h1>New Alarm</h1>
            </header>

            <main class="clInfoNovoAlarme">

                <div class="clTime">
                    <label class="clLabelTempo" for="idHora" >Time</label>
                    <input class="clHora" type="text" id="idHora" placeholder="10:30">

                    <div class="clPeriodoAm">
                        <input type="radio" id="idAm" name="nmPeriodo" value="AM" checked>
                        <label for="idAm">am</label>
                    </div>
                    <div class="clPeriodoPm">
                        <input type="radio" id="idPm" name="nmPeriodo" value="PM">
                        <label for="idPm">pm</label>
                    </div>  

                    <input class="clDescricao" type="text" id="idDescrição" maxlength="50" placeholder="Description">  
                </div>
                
                <button type="button" id="idBtnSaveNewAlarm" class="clBotaoSalvarAlarme">Save</button>
                <br><br>

                <output id="idMessageNewAlarm"></output>

            </main>

            <footer class="clRodapeNovoAlarme">
                <a href="#idTelaPrincipal"  class="link"><img src="./assets/icons/time_icon.png" alt="Imagem de um relógio como link para a página principal"></a>
            </footer>

            <div class="clBackgroundCalendario">
                <img  src="./assets/icons/34257_calendar_icon.png" alt="Imagem de uma engrenagem do botão de configuração">
            </div>
            
        </section>

        <script>

            /* Script tela Config */

            var radioButtonFormat = document.querySelectorAll("input[name='formatoHora']");
            var radioButtonTemperatureScale = document.querySelectorAll("input[name='escalaTemp']");
            var radioButtonGender = document.querySelectorAll("input[name='sexo']");
            var fieldCity = document.getElementById("idCidade");
            var fieldName = document.getElementById("idNome");
            var buttonSaveSettings = document.getElementById("idBtnSalvar");
            var fieldMessageSettings = document.getElementById("idMessageSettings");

            buttonSaveSettings.addEventListener("click", postConfig);

            document.body.addEventListener("click", function(event) {

                var element = event.target;

                if (element.id == "idIconeConfiguracao") {
                    getConfig();
                }

            })

            async function getConfig() {

                const response = await fetch(`http://localhost:3001/config`);
                const data = await response.json();
                setInfo(data);
            }

            function setInfo(info) {

                radioButtonFormat.forEach(element => {
                    
                    if (element.value == info.value.formatoHora) {
                        element.checked = true;
                    }
                });

                radioButtonTemperatureScale.forEach(element => {

                    if (element.value == info.value.escalaTemperatura) {
                        element.checked = true;
                    }
                });

                fieldCity.value = info.value.cidade;

                radioButtonGender.forEach(element => {
                    
                    if (element.value == info.value.genero) {
                        element.checked = true;
                    }
                });

                fieldName.value = info.value.nome;

            }

            async function postConfig() {

                var informations = await getInfo();
                
                const settings = {  method: 'POST',
                                    headers: {
                                                Accept: 'application/json',
                                                'Content-Type': 'application/json',
                                            }
                                };

                const response = await fetch(`http://localhost:3001/config${informations}`, settings);
                const data = await response.json();

                if (data.mensagem != undefined) {
                    fieldMessageSettings.value = data.mensagem;
                } else {
                    fieldMessageSettings.value = "Informações gravadas com sucesso!";
                }

                setTimeout(() => {
                    fieldMessageSettings.value = "";
                }, 5000);
                
            }

            async function getInfo() {
                
                var hourFormat;
                var temperatureScale;
                var city; 
                var gender;
                var name;

                radioButtonFormat.forEach(element => {
                    
                    if (element.checked == true) {
                        hourFormat = element.value;
                    }
                });

                radioButtonTemperatureScale.forEach(element => {

                    if (element.checked == true) {
                        temperatureScale = element.value;
                    }
                });

                city = fieldCity.value;

                radioButtonGender.forEach(element => {
                    
                    if (element.checked == true) {
                        gender = element.value;
                    }

                });

                name = fieldName.value;

                var informations = `?formatoHora=${hourFormat}&escalaTemperatura=${temperatureScale}&cidade=${city}&genero=${gender}&nome=${name}`;

                return informations;
            }

            /* Script tela Alarm */

            document.body.addEventListener("change", function(event) {

                var counter = 0;
                var element = event.target;

                if (element.className == "clAlarm") {
                   
                    alarms.forEach(alarm => {
            
                        counter++;

                        if (element.id == ("idAlarm" + counter)) {
                            if (alarm.isAtivo == true) {
                                alarm.isAtivo = false;
                            } else {
                                alarm.isAtivo = true;
                            }
                        }

                        
                    });

                    console.log(alarms);
                }
            });

            function createAlarms(alarmsList) {

                var counter = 0;
                var infoAlarm = document.getElementsByClassName("clInfoAlarme");

                while(infoAlarm[0].hasChildNodes()) {
                    infoAlarm[0].removeChild(infoAlarm[0].firstChild);
                }
                
                alarmsList.forEach(element => {

                    counter++;

                    var alarmDiv = document.createElement('div');
                    alarmDiv.className = "clAlarme";

                    var alarmCheckbox = document.createElement('input');
                    alarmCheckbox.type = "checkbox";
                    alarmCheckbox.id= "idAlarm" + counter;
                    alarmCheckbox.name = "nmAlarm" + counter;
                    alarmCheckbox.className = "clAlarm";

                    if (element.isAtivo == true) {
                        alarmCheckbox.checked = true;
                    } else {
                        alarmCheckbox.checked = false;
                    }

                    var alarmLabel = document.createElement('label');
                    alarmLabel.htmlFor = "idAlarm" + counter;

                    if (element.isAm == true) {
                        alarmLabel.innerText = element.hora + "am";
                    } else {
                        alarmLabel.innerText = element.hora + "pm";
                    }

                    var alarmText = document.createElement('p');
                    alarmText.innerText = element.descricao;

                    alarmDiv.appendChild(alarmCheckbox);
                    alarmDiv.appendChild(alarmLabel);
                    alarmDiv.appendChild(alarmText);
                    infoAlarm[0].appendChild(alarmDiv);
                     
                });

            }

            /* Script tela New Alarm */

            var alarms = [];
            var periodSelected = true;
            
            var fieldHour = document.getElementById("idHora");
            var fieldDescription = document.getElementById("idDescrição");
            var btnSaveNewAlarm = document.getElementById("idBtnSaveNewAlarm");
            var fieldMessageNewAlarm = document.getElementById("idMessageNewAlarm");
            
            btnSaveNewAlarm.addEventListener("click", function() {
                
                var hour = consistHour();
                var description = fieldDescription.value;
                
                if (alarms.length < 6) {
                    if (hour != false) {
                        var alarm = {isAtivo: true, hora: hour, isAm: periodSelected, descricao: description};
                        alarms.push(alarm);
                        
                        fieldHour.value = "";
                        fieldDescription.value = "";
                        var fieldPeriod = document.getElementById("idAm");
                        fieldPeriod.checked = true;
                        periodSelected = true;
                        
                        /*Create Alarms vai para página principal no botão set alarm*/
                        createAlarms(alarms);
                        var url = location.href;
                        location.href = "#idTelaAlarme"; 
                        history.replaceState(null, null, url);
                    
                    } else {
                        fieldMessageNewAlarm.value = "Por favor informe uma hora no intervalo de 00:00 às 11:59";

                        setTimeout(() => {
                            fieldMessageNewAlarm.value = "";
                        }, 5000);
                    } 
                } else {
                    fieldMessageNewAlarm.value = "O número máximo de alarmes já foi cadastrado";

                    setTimeout(() => {
                        fieldMessageNewAlarm.value = "";
                        fieldHour.value = "";
                        fieldDescription.value = "";
                        var fieldPeriod = document.getElementById("idAm");
                        fieldPeriod.checked = true;
                        periodSelected = true;
                    }, 5000);
                } 

            });

            function consistHour() {

                var hour = String(fieldHour.value);
                var timeList = hour.split(":");

                for (let index = 0; index < timeList.length; index++) {
                    
                    if (index == 0) {
                        if ((timeList[index] == undefined) || (timeList[index] == "") || (timeList[index] > 11)) {

                            return false;
                        } else if ((timeList[index].length == 1) && (timeList[index] < 10)) {

                            timeList[index] = "0" + timeList[index];
                        }
                    }

                    if (index == 1) {
                        if (timeList[index] > 59) {

                            return false;
                        } else if ((timeList[index].length == 1) && (timeList[index] < 10)) {

                            timeList[index] = "0" + timeList[index];
                        } else if (timeList[index] == "")  {

                            timeList[index] = "00";
                        }           
                    } 
                    
                }           

                if ((timeList[1] == undefined)) {
                    timeList[1] = "00";
                }

                for (let index = 0; index < timeList.length; index++) {
                    
                    if (index == 0) {
                        
                        if ((periodSelected == false) && (timeList[index] == "00")) {
                            timeList[index] = "12";
                        }

                        hour = timeList[index];
                    } else {
                        hour += ":" + timeList[index];
                    }
                }

                return hour;
            }

            fieldHour.addEventListener("keydown", function(event){

                var key = event.key;
                var condition = (((key >= 0) && (key <= 9)) || (key == "Backspace"));

                if (key == "Tab") {
                    fieldDescription.focus();
                }

                if (condition == false) {

                    event.preventDefault();

                } else if (key != "Backspace"){

                    var hour = String(fieldHour.value);

                    if (hour.length <= 4) {

                        while (hour.indexOf(":") > 0) {
                            hour = hour.replace(":","");
                        }

                        fieldHour.value = hour.replace(/.{2}/g, '$&:');     
                    } else {
                        event.preventDefault();
                    } 
                }

            });

            document.body.addEventListener("change", function(event) {

                var element = event.target;

                if ((element.id == "idAm") || (element.id == "idPm")) {

                    var period = document.querySelector('input[name="nmPeriodo"]:checked').value;

                    if (period == "AM") {
                        periodSelected = true;
                    } else {
                        periodSelected = false;
                    }
                }
            });


        </script>

    </body>
</html>